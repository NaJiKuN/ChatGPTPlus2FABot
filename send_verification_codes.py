#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ø³ÙƒØ±ÙŠØ¨Øª Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…ÙˆØ² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© 2FA
ÙŠØ³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ù…Ø¹ cron job Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…ÙˆØ² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ
"""

import logging
import sqlite3
import os
import pyotp
import datetime
import pytz
import sys
import telegram
import asyncio

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
    filename="/home/ec2-user/projects/ChatGPTPlus2FABot/send_codes.log"
)
logger = logging.getLogger(__name__)

# ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª
TOKEN = "8119053401:AAHuqgTkiq6M8rT9VSHYEnIl96BHt9lXIZM"

# Ù…Ø³Ø§Ø± Ù…Ù„Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
DB_FILE = "/home/ec2-user/projects/ChatGPTPlus2FABot/bot_data.db"

# ÙˆØ¸Ø§Ø¦Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
def get_active_groups():
    """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."""
    try:
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute(
            "SELECT group_id, totp_secret, interval_minutes, message_format, timezone, time_format FROM groups WHERE is_active = 1"
        )
        active_groups = cursor.fetchall()
        conn.close()
        return active_groups
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©: {e}")
        return []

# ÙˆØ¸Ø§Ø¦Ù TOTP
def generate_totp(secret):
    """ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² TOTP Ù…Ù† Ø³Ø±."""
    totp = pyotp.TOTP(secret)
    return totp.now()

def format_next_time(interval_minutes, timezone_str="Asia/Jerusalem", time_format="12h"):
    """ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ù„Ø±Ø³Ø§Ù„Ø©."""
    tz = pytz.timezone(timezone_str)
    now = datetime.datetime.now(tz)
    next_time = now + datetime.timedelta(minutes=interval_minutes)
    
    if time_format == "12h":
        return next_time.strftime("%I:%M:%S %p")  # ØªÙ†Ø³ÙŠÙ‚ 12 Ø³Ø§Ø¹Ø© Ù…Ø¹ AM/PM
    else:
        return next_time.strftime("%H:%M:%S")  # ØªÙ†Ø³ÙŠÙ‚ 24 Ø³Ø§Ø¹Ø©

# ÙˆØ¸ÙŠÙØ© Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…ÙˆØ² Ø§Ù„ØªØ­Ù‚Ù‚
async def send_verification_codes():
    """Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…ÙˆØ² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©."""
    try:
        # Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ø¨ÙˆØª
        bot = telegram.Bot(token=TOKEN)
        
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
        active_groups = get_active_groups()
        
        if not active_groups:
            logger.info("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù†Ø´Ø·Ø©.")
            return
        
        for group in active_groups:
            group_id, totp_secret, interval, message_format, timezone, time_format = group
            
            if not totp_secret:
                logger.warning(f"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© {group_id} Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡Ø§ Ø³Ø± TOTP Ù…ÙƒÙˆÙ†.")
                continue
            
            # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ØªØ§Ù„ÙŠ
            next_time = format_next_time(interval, timezone, time_format)
            
            # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            if not message_format:
                message_format = 'ğŸ” 2FA Verification Code\n\nNext code at: {next_time}'
            
            message = message_format.format(next_time=next_time)
            
            # Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ù…Ø¶Ù…Ù†Ø© Ù…Ø¹ Ø²Ø± Copy Code
            keyboard = [[telegram.InlineKeyboardButton("Copy Code", callback_data=f'copy_code_{group_id}')]]
            reply_markup = telegram.InlineKeyboardMarkup(keyboard)
            
            try:
                # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
                await bot.send_message(chat_id=group_id, text=message, reply_markup=reply_markup)
                logger.info(f"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© {group_id}")
            except Exception as e:
                logger.error(f"ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© {group_id}: {e}")
    
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ send_verification_codes: {e}")

# Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
async def main():
    """Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø³ÙƒØ±ÙŠØ¨Øª."""
    try:
        logger.info("Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±ÙŠØ¨Øª Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…ÙˆØ² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...")
        await send_verification_codes()
        logger.info("Ø§ÙƒØªÙ…Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…ÙˆØ² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©.")
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: {e}")

if __name__ == "__main__":
    # ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    asyncio.run(main())
