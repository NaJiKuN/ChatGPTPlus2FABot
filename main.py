import os
import logging
import pyotp
from telegram import ParseMode
from telegram.ext import Updater, CommandHandler, CallbackContext
from datetime import datetime, timedelta
from flask import Flask, Response

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

app = Flask(__name__)

# Ø§Ù„ØªÙƒÙˆÙŠÙ†Ø§Øª
BOT_TOKEN = os.getenv('BOT_TOKEN', "8119053401:AAHuqgTkiq6M8rT9VSHYEnIl96BHt9lXIZM")
GROUP_CHAT_ID = int(os.getenv('GROUP_CHAT_ID', "-1002329495586"))
TOTP_SECRET = os.getenv('TOTP_SECRET', "ZV3YUXYVPOZSUOT43SKVDGFFVWBZXOVI")

@app.route('/')
def health_check():
    return Response("âœ… 2FA Bot is running", status=200)

def send_2fa_code(context: CallbackContext):
    try:
        current_code = pyotp.TOTP(TOTP_SECRET).now()
        expiry_time = datetime.now() + timedelta(minutes=10)
        
        message = f"""
ğŸ” *ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ©*

ğŸ“‹ Ø§Ù„ÙƒÙˆØ¯: `{current_code}`

â³ ØµØ§Ù„Ø­ Ø­ØªÙ‰: {expiry_time.strftime('%H:%M:%S')} UTC

_ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ø®Ù„Ø§Ù„ 10 Ø¯Ù‚Ø§Ø¦Ù‚_
        """
        
        context.bot.send_message(
            chat_id=GROUP_CHAT_ID,
            text=message,
            parse_mode=ParseMode.MARKDOWN_V2
        )
        logger.info(f"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯: {current_code}")
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: {e}")

def start_command(update, context):
    try:
        context.bot.send_message(
            chat_id=update.effective_chat.id,
            text="ğŸ¤– Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ ÙˆÙŠÙ‚ÙˆÙ… Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚",
            parse_mode=ParseMode.MARKDOWN_V2
        )
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø£Ù…Ø± Ø§Ù„Ø¨Ø¯Ø¡: {e}")

def run_bot():
    try:
        updater = Updater(BOT_TOKEN, use_context=True)
        dp = updater.dispatcher
        
        dp.add_handler(CommandHandler("start", start_command))
        
        job_queue = updater.job_queue
        job_queue.run_repeating(send_2fa_code, interval=600, first=10)
        
        logger.info("ğŸŸ¢ ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­")
        updater.start_polling()
        updater.idle()
    except Exception as e:
        logger.error(f"ğŸ”´ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: {e}")

if __name__ == '__main__':
    # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ´ØºÙŠÙ„ ÙƒÙ€ Worker
    if os.getenv('RUN_AS_WORKER') == 'true':
        logger.info("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨ÙˆØª...")
        run_bot()
    else:
        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ´ØºÙŠÙ„ ÙƒÙ€ Web Service
        PORT = int(os.environ.get('PORT', 10000))
        logger.info("ğŸŒ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„ÙˆÙŠØ¨...")
        app.run(host='0.0.0.0', port=PORT)
